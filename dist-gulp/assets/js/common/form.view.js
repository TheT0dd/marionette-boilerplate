define(["app","backbone.syphon","bootstrap-datetimepicker"],function(t){var e={customToggler:"data-custom-toggler",arrayInput:"data-parse-as-array",selectLimit:"data-select-limit",dateTime:"data-datetime"},i={formGroup:".form-group",submitButton:".btn-submit",cancelButton:".btn-cancel",fileButton:".file-upload",preloader:".preloader",validationError:".validation-error",filePreviewList:"ul.file-preview-list"},r={hidden:"hidden",formWithErrors:"has-errors",formGroupWithErrors:"has-error"},n=function(t,e){console.log("Validating file: ",e);var i={type:{any:/.*/gim,document:/pdf|msword|officedocument\.word|opendocument\.text/gim,image:/image\/(jpeg|png|gif)/gim},suffix:{any:/.*/gim,document:/(\.pdf$)|(\.doc$)|(\.docx$)|(\.odt$)/gim,image:/(\.jpe?g$)|(\.png$)|(\.gif$)/gim}};t=t.split(",");for(var r=0,n=t.length;n>r;r++){var o=$.trim(t[r]);if(i.type[o]&&i.type[o].test(e.type)||i.suffix[o]&&i.suffix[o].test(e.name))return!0}return!1};return Marionette.ItemView.extend({_ui:{form:"form",namedElements:"[name]",formGroup:i.formGroup,submitButton:i.submitButton,cancelButton:i.cancelButton,preloader:i.preloader,validationError:i.validationError,customToggler:"["+e.customToggler+"]",arrayInput:"["+e.arrayInput+"]",limitedCheckbox:i.formGroup+"["+e.selectLimit+"] [type=checkbox]",fileButton:i.fileButton,fileInput:"input[type=file]",input:"input",datetimeInput:"["+e.dateTime+"]"},events:{"click @ui.submitButton":"submitForm","click @ui.cancelButton":"cancelForm","click @ui.fileButton":"triggerFileBrowse","change @ui.fileInput":"handleFileSelect","keypress @ui.input":"submitOnEnter"},constructor:function(){this.ui=_.extend({},this._ui,this.ui),this._files={},this.on("render",function(){this.applyCheckboxLimit(),this.bindCustomInputTogglers(),this.initDatetimePicker()}),this.on("before:destroy",function(){console.log("before:destroy ",this,this._files),this.ui.namedElements.off()}),Marionette.ItemView.prototype.constructor.apply(this,arguments)},onShowPreloader:function(){this.ui.submitButton.addClass(r.hidden),this.ui.preloader.removeClass(r.hidden)},onHidePreloader:function(){this.ui.preloader.addClass(r.hidden),this.ui.submitButton.removeClass(r.hidden)},onClearValidationErrors:function(){this.ui.form.removeClass(r.formWithErrors),this.ui.formGroup.removeClass(r.formGroupWithErrors),this.ui.validationError.addClass(r.hidden).empty()},_getBracketNotation:function(t){var e=t.split(".");return e.reduce(function(t,e,i,r){var n;return n=i>1?t+"]["+e:t+"["+e,i===r.length-1&&(n+="]"),n})},_showValidationErrors:function(t){var e=this;_.each(t,function(t,n){if(t instanceof Object)e._showValidationErrors(t);else{var o=e._getBracketNotation(n),a=e.$el.find('[name="'+o+'"]');0===a.length&&(a=e.$el.find('[name^="'+o+'"]'));var s=a.closest(i.formGroup);s.addClass(r.formGroupWithErrors),s.find(i.validationError).html(t).removeClass(r.hidden)}}),$("html, body").animate({scrollTop:0})},onShowValidationErrors:function(t){t&&0!==t.length&&(this.triggerMethod("clear:validation:errors"),this.triggerMethod("show:main:form:error"),this._showValidationErrors(t))},onShowMainFormError:function(){this.ui.form.addClass(r.formWithErrors)},applyCheckboxLimit:function(){this.ui.limitedCheckbox.on("change",function(t){var r=$(t.target),n=r.closest(i.formGroup),o=parseInt(n.attr(e.selectLimit),10),a=n.find("input[type=checkbox]:checked");o>0&&a.length>o&&(r.prop("checked",!1),t.preventDefault())})},bindCustomInputTogglers:function(){var t=this,n=function(t,e){t.prop("checked")||t.prop("selected")?e.removeClass(r.hidden).focus():e.addClass(r.hidden)};t.ui.customToggler.each(function(){var r=$(this),o=r.closest(i.formGroup),a=r.attr(e.customToggler),s=t.$el.find("[name="+a+"]");if(/option/i.test(r.prop("tagName"))){var l=r.closest("select");l.on("change",function(t){n(r,s)})}if(/input/i.test(r.prop("tagName"))){var u=r.attr("name").split("[")[0],c=o.find("[name^="+u+"]");c.on("change",function(t){n(r,s)})}s.on("keypress keydown keyup",function(t){r.val(s.val())})})},_consumeCustomInputs:function(t){var i=_.extend({},t),r=this;return r.ui.customToggler.each(function(){var t=$(this),n=t.attr(e.customToggler),o=r.$el.find("[name="+n+"]"),a=(t.val(),t.attr("name")),s=/([\s\S]+)\[([\s\S]+)\]/;if(s.test(a)){var l=a.match(s);_.each(i[l[1]],function(t,e){e===l[2]&&t===!0&&(o.val().length>0&&(i[l[1]][o.val()]=!0),delete i[l[1]][e])})}else delete i[n]}),i},_consumeCheckboxGroups:function(t){var e=_.extend({},t),i=this;return _.each(e,function(t,r){if(t instanceof Object){var n=i.$el.find("[name^="+r+"]");if("checkbox"===n.attr("type")&&"undefined"==typeof n.attr("data-parse-as-dictionary")){var o=_.map(t,function(t,e){return t===!0?e:!1});o=_.reject(o,function(t){return t===!1}),e[r]=o}}}),e},_consumeArrayData:function(t){var e=_.extend({},t);return this.ui.arrayInput.each(function(){var t=$(this).attr("name");if(!t||!e[t])return!0;var i=e[t],r=i.split(/[,\s]/).map(function(t){return $.trim(t)});r=_.reject(r,function(t){return 0===t.length}),e[t]=r}),e},_consumeFiles:function(t){var e=_.extend({},t),i=this;return this.ui.fileInput.each(function(){var t=$(this).attr("name");if(!t)return!0;if(t in i._files){var r=i._files[t].map(function(t){return t.file});e[t]=r}else e[t]=[]}),e},_consumeDates:function(t){var e=_.extend({},t);return this.ui.datetimeInput.each(function(){var i=$(this).attr("name");i&&i in t&&(e[i]=moment.utc(e[i]).format())}),e},consumeFormData:function(){var t=Backbone.Syphon.serialize(this);return t=this._consumeCustomInputs(t),t=this._consumeCheckboxGroups(t),t=this._consumeArrayData(t),t=this._consumeFiles(t),t=this._consumeDates(t)},submitForm:function(t){t.preventDefault();var e=this.consumeFormData();this.trigger("submit",e)},cancelForm:function(t){t.preventDefault(),this.trigger("cancel")},triggerFileBrowse:function(t){var e=$(t.currentTarget),i=e.attr("data-bound-file-input"),r=this.ui.fileInput.filter("[name="+i+"]");r.trigger("click")},handleFileSelect:function(r){var o=this,a=$(r.target),s=a.attr("name"),l=a.attr(e.selectLimit)||0,u=a.closest(i.formGroup).find(i.filePreviewList),c=a.attr("data-accepted-type"),f=u.attr("data-list-item-class"),d=a[0].files;if(!s)throw new Error("The file input needs a name for the file parser to properly work");s in o._files||(o._files[s]=[]);for(var h,m=[],p=0;h=d[p];p++){if(l&&o._files[s].length+1>l){t.execute("notify",{title:"File limit reached",text:"Only <b>"+l+"</b> file"+(l>1?"s are":" is")+" allowed in this field",type:"warning"});break}if(n(c,h)){var g="file_"+_.uniqueId();o._files[s].push({id:g,file:h});{h.type}m.push('<li data-file-id="',g,'" class="closable ',f,'">'),m.push("<strong>",h.name,"</strong>"),m.push(" - ",parseInt(h.size/1024,10)," KB"),m.push('<span class="closer" aria-hidden="true">&times;</span></li>')}else t.execute("notify",{title:"Invalid file",text:"File <strong>"+h.name+"</strong> is not of an accepted ["+c+"] format",type:"error"})}u.append(m.join("")),o._handleFileDeletion(u,s)},showExistingFiles:function(t,e){var i=this;_.each(t,function(t,r,n){var o=i.ui.fileInput.filter('[name="'+r+'"]');if(o.length>0)if(t instanceof Array)for(var a,s=0;a=t[s];s++)i.addExistingFile(t[s],r,e);else i.addExistingFile(t,r,e)})},addExistingFile:function(t,r,n){if(t&&r){var o=this.ui.fileInput.filter('[name="'+r+'"]');if(0===o.length)throw new Error("There is no input with name `"+r+"` to attach the file");r in this._files||(this._files[r]=[]);var a=o.attr(e.selectLimit)||0;if(this._files[r].length+1>a)throw new Error("File limit ("+a+") reached for input`"+r+"`");var s="file_"+_.uniqueId();this._files[r].push({id:s,file:null,url:t});var l=o.closest(i.formGroup).find(i.filePreviewList),u=l.attr("data-list-item-class"),c=[];c.push('<li data-file-id="',s,'" class="closable ',u,'">'),c.push('<a target="_blank" href="',n+"/"+t,'">'),c.push("<strong>",t.split("/").pop(),"</strong>"),c.push("</a>"),c.push('<span class="closer" aria-hidden="true">&times;</span></li>'),l.append(c.join("")),this._handleFileDeletion(l,r)}},_handleFileDeletion:function(t,e){var i=this;t.off().on("click",".closer",function(t){var r=$(this).closest("li");r.animate({opacity:0},200,function(){r.remove()});var n=r.attr("data-file-id");i._files[e]=_.reject(i._files[e],function(t){return t.id===n&&i.trigger("file:deleted",e,t.url),t.id===n})})},initDatetimePicker:function(){this.ui.datetimeInput.datetimepicker({pickTime:!1,useCurrent:!1})},submitOnEnter:function(t){13===t.which&&this.submitForm(t)}})});