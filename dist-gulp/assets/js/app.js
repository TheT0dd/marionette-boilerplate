define(["marionette","common/ajax.utility","apps/config/spinner/options","apps/config/marionette/regions/header","apps/config/marionette/regions/sidebar","apps/config/marionette/regions/main","apps/config/marionette/regions/dialog","apps/config/marionette/regions/loading","apps/config/marionette/regions/overlay","apps/config/validator/validator"],function(e,o,n){var t=window.App=new e.Application,i={};i.EnableCORS=!0,i.landingTrigger={admin:"some:trigger",user:"some:other:trigger",guest:"splash:show"},i.unprotectedURL=/splash|login|register|^static/,i.FileSizeLimit=2097152,i.RootURL="";var r=e.Region.Header.extend({el:"#header-section"}),a=e.Region.Sidebar.extend({el:"#sidebar-section"}),s=e.Region.Main.extend({el:"#main-region"}),g=e.Region.Dialog.extend({el:"#dialog-region"}),p=e.Region.Loading.extend({el:"#loading-region"}),l=e.Region.Overlay.extend({el:"#overlay-region"}),c=e.LayoutView.extend({el:"body",regions:{header:r,sidebar:a,main:s,dialog:g,loading:p,overlay:l}});return t.rootView=new c,require(["common/behaviors"],function(o){e.Behaviors.behaviorsLookup=function(){return o}}),t.isLoggedIn=!1,t.requestedGuestUrl=!1,t.navigate=function(e,o){var n=o||{};Backbone.history.navigate(e,n)},t.getCurrentRoute=function(){return Backbone.history.fragment},t.executeAction=function(e,o,n){var n="undefined"!=typeof n?n:{};return n.asModal||t.execute("deselect:all:sidebar"),t.startSubApp(e,n.asModal),o(n)},t.startSubApp=function(e,o,n){var i=e?t.module(e):null;return o?(t.dialogApp=i,void i.start(n)):(t.rootView.getRegion("dialog").closeModal(),void(t.currentApp!==i&&(t.currentApp&&t.currentApp.stop(),t.currentApp=i,i&&i.start(n))))},t.stopDialogApp=function(){t.dialogApp&&t.dialogApp!==t.currentApp&&(t.dialogApp.stop(),delete t.dialogApp)},t.showLanding=function(e){var o=e?e.get("role"):"guest",n=t.request("setting","landingTrigger")[o];t.trigger(n)},t.goBack=function(){window.history.back()},t.encode=function(e){return encodeURIComponent(encodeURIComponent(e))},t.decode=function(e){return decodeURIComponent(decodeURIComponent(e))},t.openInNewTab=function(e){var o=window.open(e,"_blank");o.focus()},t.goToUrl=function(e){window.location.href=e},t.openPopup=function(e){var o="left=10,top=10,resizable=yes,scrollbars=no,status=0,toolbar=0,width=920,height=436";return window.open(e,"App Popup",o)},t.initForMember=function(e){t.trigger("login",e,!1),Backbone.history.start(),""===t.getCurrentRoute()&&t.showLanding(e)},t.initForGuest=function(){console.log("initForGuest"),Backbone.history.start({silent:!0}),i.unprotectedURL.test(t.getCurrentRoute())?(Backbone.history.stop(),Backbone.history.start({silent:!1}),""===t.getCurrentRoute()&&t.showLanding()):(t.requestedGuestUrl=t.getCurrentRoute(),t.showLanding())},t.commands.setHandler("refresh:mainRegion",function(){var e=t.getCurrentRoute();Backbone.history.fragment=null,t.navigate(e,{trigger:!0}),console.log("App:refresh:mainRegion")}),t.on("login",function(e,o){console.info("User logged in. Role: ",e.get("role")),t.isLoggedIn=!0,o&&t.execute("refresh:mainRegion")}),t.on("logout",function(){t.isLoggedIn=!1,t.trigger("splash:show")}),t.reqres.setHandler("setting",function(e){return i[e]}),t.on("before:start",function(){i.EnableCORS&&o.enableCORS(),console.info("App: pre-start tasks complete.")}),t.on("start",function(){Backbone.history&&require(["apps/header/header_app","apps/sidebar/sidebar_app","apps/splash/splash_app","apps/users/users_app","apps/static/static_app","common/notify","mailer/mailer","cache/cache"],function(e,o,n,i,r,a,s,g){var p=t.request("cache:fetch:logged:user");p.done(function(e){Boolean(e)?t.initForMember(e):t.initForGuest()}),p.fail(function(){t.initForGuest()}),p.always(function(){e.start(),Backbone.history.on("route",function(){t.rootView.getRegion("dialog").closeModal(),t.rootView.getRegion("overlay").closeOverlay()}),console.info("App: post-start tasks complete.")})})}),t});